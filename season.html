<!DOCTYPE html>
<html>
    <head>
        <title>LuxFoot | Seasons</title>
        <link href="styles.css" rel="stylesheet" />
    </head>
    <body>
        <h1>Luxembourgish Football: Seasons</h1>
        <a href="index.html">Home</a> | <a href="seasons.html">Seasons</a>
        <script>
            params=[];
            window.location.search.replace("?","").split("&").forEach(param=>{parts=param.split("=");params[parts[0]]=parts[1];});
            season = params.year;
            seasonPath = [season[0]+""+season[1],season[2],season[3]+"-"+season.split("-")[1]];
            dataKeys = [];

            allTeams = null;
            fetch("data/teams.json")
                .then(response => {
                    return response.json();
                })
                .then(data => {
                    allTeams = data;
                    return fetch("seasons/"+seasonPath.join("/")+".json")
                })
                .then(response => {
                    if ( ! response.ok ) {
                        console.error(error.message);
                        return {"invalid":true};
                    }
                    return response.json()
                })
                .then(data => {
                    if ( data.invalid ) {
                        return;
                    }

                    dataKeys = getAllKeys(data);

                    dataKeys.push("link from standings to playoff");

                    document.getElementsByTagName("title")[0].textContent += " | " + data.season;
                    document.getElementsByTagName("h1")[0].textContent += " : " + data.season;

                    if ( data.league ) {
                        dataKeys = dataKeys.filter(key => key !== 'league');
                        data.league.forEach(league=>{
                            h2 = document.createElement("H2");
                            dataKeys = dataKeys.filter(key => key !== 'league.name');
                            h2.textContent = league.name;
                            dataKeys = dataKeys.filter(key => key !== 'league.level');
                            h2.id = "league_" + league.level;
                            document.body.append(h2);

                            // note
                            if ( league.note ) {
                                dataKeys = dataKeys.filter(key => key !== 'league.note');
                                note = document.createElement("P");
                                note.textContent = "Note: " + league.note;
                                document.body.append(note);
                            }

                            if ( league.standings ) {
                                dataKeys = dataKeys.filter(key => key !== 'league.standings');
                                drawStandings(league.standings);
                            }
                        });
                    }

                    if ( data.playoffs ) {
                        dataKeys = dataKeys.filter(key => key !== 'playoffs');
                        Object.entries(data.playoffs).forEach(([poName, poData])=>{
                            h2 = document.createElement("H2");
                            dataKeys = dataKeys.filter(key => key !== ('playoffs.'+poName));
                            h2.textContent = "Playoff: " + playoffNames(poName);
                            h2.id = "playoff_" + poName;
                            document.body.append(h2);

                            if ( poData.matches ) {
                                dataKeys = dataKeys.filter(key => key !== ('playoffs.'+poName+'.matches'));
                                matchTable = document.createElement("TABLE");
                                matchTabelBody = document.createElement("TBODY");
                                poData.matches.forEach(match=>{
                                    matchTabelBody.append( drawMatch(match) );
                                });
                                matchTable.append(matchTabelBody);
                                document.body.append(matchTable);
                            }
                        });
                    }

                    console.log(dataKeys);
                });
            
            function drawMatch(matchData) {
                match_tr = document.createElement("TR");

                td_date = document.createElement("TD");
                td_date.textContent = matchData.date;
                td_date.classList.add("match-date");
                match_tr.append(td_date);

                td_home = document.createElement("TD");
                td_home.textContent = allTeams[matchData.home].name;
                td_home.classList.add("team-name");
                td_home.classList.add("match-home");
                match_tr.append(td_home);

                td_score = document.createElement("TD");
                td_score.textContent = matchData.score;
                td_score.classList.add("match-score");
                match_tr.append(td_score);

                td_away = document.createElement("TD");
                td_away.textContent = allTeams[matchData.away].name;
                td_away.classList.add("team-name");
                td_away.classList.add("match-away");
                match_tr.append(td_away);

                td_outcome = document.createElement("TD");
                td_outcome.textContent = matchData.outcome;
                td_outcome.classList.add("team-notes");
                match_tr.append(td_outcome);

                return match_tr;
            }

            function playoffNames(poName) {
                switch( poName ) {
                    case "title":
                        return "Title decider";
                        break;
                }
                return "???";
            }

            function drawStandings(standingsData) {
                table = document.createElement("TABLE");
                
                thead = document.createElement("THEAD");
                thead_tr = document.createElement("TR");
                
                th_place = document.createElement("TH");
                th_place.textContent = "#";
                thead_tr.append(th_place);

                th_team = document.createElement("TH");
                th_team.textContent = "Team";
                thead_tr.append(th_team);

                stats = [
                    ["P","Played"],
                    ["W","Won"],
                    ["D","Draw"],
                    ["L","Lost"],
                    ["F","Goals For"],
                    ["A","Goals Against"],
                    ["Pts","Points"],
                    ["GD","Goal Difference"]
                ];
                stats.forEach(s=>{
                    th_stat = document.createElement("TH");
                    th_stat_abbr = document.createElement("ABBR");
                    th_stat_abbr.textContent = s[0];
                    th_stat_abbr.title = s[1];
                    th_stat.append(th_stat_abbr);
                    thead_tr.append(th_stat);
                });

                th_notes = document.createElement("TH");
                th_notes.textContent = "Notes";
                thead_tr.append(th_notes);

                thead.append(thead_tr);
                table.append(thead);

                tbody = document.createElement("TBODY");
                
                standingsData.forEach(row=>{
                    tbody_tr = document.createElement("TR");

                    tr_place = document.createElement("TD");
                    tr_place.textContent = row.place;
                    dataKeys = dataKeys.filter(key => key !== 'league.standings.place');
                    tbody_tr.append(tr_place);

                    tr_team = document.createElement("TD");
                    tr_team.textContent = allTeams[row.team].name;
                    tr_team.classList.add("team-name");
                    dataKeys = dataKeys.filter(key => key !== 'league.standings.team');
                    tbody_tr.append(tr_team);

                    if ( ! row.missing ) {
                        td_stat = document.createElement("TD");
                        td_stat.textContent = row.w + row.d + row.l;
                        tbody_tr.append(td_stat);
                        stats = ["w","d","l","f","a"];
                        stats.forEach(s=>{
                            td_stat = document.createElement("TD");
                            td_stat.textContent = row[s];
                            tbody_tr.append(td_stat);
                        });
                        td_stat = document.createElement("TD");
                        td_stat.textContent = (row.w*row.pts_win) + row.d;
                        tbody_tr.append(td_stat);
                        dataKeys = dataKeys.filter(key => key !== 'league.standings.pts_win');
                        td_stat = document.createElement("TD");
                        td_stat.textContent = row.f - row.a;
                        tbody_tr.append(td_stat);
                    } else {
                        dataKeys = dataKeys.filter(key => key !== 'league.standings.missing');
                        td_stats = document.createElement("TD");
                        td_stats.textContent = "Missing data";
                        td_stats.setAttribute("colspan",8);
                        tbody_tr.append(td_stats);
                    }

                    rowNotes = [];

                    if ( row.champion ) {
                        dataKeys = dataKeys.filter(key => key !== 'league.standings.champion');
                        tbody_tr.classList.add("is-champion");
                        rowNotes.push("Champion");
                    }

                    if ( row.playoff ) {
                        dataKeys = dataKeys.filter(key => key !== 'league.standings.playoff');
                        rowNotes.push( playoffNames(row.playoff) );
                    }

                    tr_notes = document.createElement("TD");
                    tr_notes.textContent = rowNotes.join("; ");
                    tr_notes.classList.add("team-notes");
                    tbody_tr.append(tr_notes);

                    tbody.append(tbody_tr);
                });

                table.append(tbody);

                document.body.append(table);
            }


            function getAllKeys(obj, prefix = '') {
                const keys = new Set();
                function traverse(current, path) {
                    if (current === null || typeof current !== 'object') {
                    return;
                    }
                    
                    if (Array.isArray(current)) {
                    // For arrays, traverse each element
                    current.forEach(item => traverse(item, path));
                    } else {
                    // For objects, add each key and traverse its value
                    Object.keys(current).forEach(key => {
                        const newPath = path ? `${path}.${key}` : key;
                        keys.add(newPath);
                        traverse(current[key], newPath);
                    });
                    }
                }                
                traverse(obj, prefix);
                return Array.from(keys).sort();
            }
        </script>
    </body>
</html>