<!DOCTYPE html>
<html>
    <head>
        <title>LuxFoot | Seasons</title>
        <link href="styles.css" rel="stylesheet" />
        <script src="scripts.js" type="text/javascript"></script>
    </head>
    <body>
        <h1>
            <a href="index.html">Luxembourgish Football</a>:
            <a href="seasons.html">Seasons</a>
        </h1>
        <div id="nav"></div>
        <script>
            params=[];
            window.location.search.replace("?","").split("&").forEach(param=>{parts=param.split("=");params[parts[0]]=parts[1];});
            season = params.year;
            seasonPath = [season[0]+""+season[1],season[2],season[3]+"-"+season.split("-")[1]];
            dataKeys = [];

            allTeams = null;
            fetch("data/teams.json")
                .then(response => {
                    return response.json();
                })
                .then(data => {
                    allTeams = data;
                    return fetch("seasons/"+seasonPath.join("/")+".json")
                })
                .then(response => {
                    if ( ! response.ok ) {
                        errorP = document.createElement("P");
                        errorP.classList.add("error");
                        errorP.textContent = "Season not found";
                        document.body.append(errorP);
                        return {"invalid":true};
                    }
                    return response.json();
                })
                .then(data => {
                    if ( data.invalid ) {
                        return;
                    }

                    handleData(data);
                })
                .then(()=>{
                    const hash = window.location.hash;
                    if (hash) {
                        const element = document.querySelector(hash);
                        if (element) {
                            element.scrollIntoView({ behavior: 'smooth' });
                        }
                    }
                });
            
            function handleData(data) {
                dataKeys = getAllKeys(data);

                document.getElementsByTagName("title")[0].textContent += " | " + data.season;
                document.getElementsByTagName("h1")[0].innerHTML += " : " + data.season;
                dataKeys = dataKeys.filter(key => key !== 'season');

                if ( data.note ) {
                    dataKeys = dataKeys.filter(key => key !== 'note');
                    globalNote = document.createElement("P");
                    globalNote.textContent = "Note: " + data.note;
                    document.body.append(globalNote);
                }

                navbar = document.getElementById("nav");
                if ( data.prev ) {
                    dataKeys = dataKeys.filter(key => key !== 'prev');
                    aPrev = document.createElement("A");
                    aPrev.setAttribute("href","season.html?year="+data.prev);
                    aPrev.textContent = data.prev;
                    if ( navbar.textContent !== "" ) {
                        navbar.append(" | ");
                    }
                    navbar.append(aPrev);
                }
                if ( data.next ) {
                    dataKeys = dataKeys.filter(key => key !== 'next');
                    aNext = document.createElement("A");
                    aNext.setAttribute("href","season.html?year="+data.next);
                    aNext.textContent = data.next;
                    if ( navbar.textContent !== "" ) {
                        navbar.append(" | ");
                    }
                    navbar.append(aNext);
                }

                if ( data.league ) {
                    dataKeys = dataKeys.filter(key => key !== 'league');
                    data.league.forEach(league=>{
                        if ( ! league.series ) {
                            h2 = document.createElement("H2");
                            dataKeys = dataKeys.filter(key => key !== 'league.name');
                            h2.textContent = league.name;
                            dataKeys = dataKeys.filter(key => key !== 'league.level');
                            h2.id = "league_" + league.level;
                            document.body.append(h2);
                        } else {
                            dataKeys = dataKeys.filter(key => key !== 'league.series');
                            drawSeries(league);
                        }

                        if ( league.note ) {
                            dataKeys = dataKeys.filter(key => key !== 'league.note');
                            note = document.createElement("P");
                            note.textContent = "Note: " + league.note;
                            document.body.append(note);
                        }

                        if ( league.pts_win ) {
                            dataKeys = dataKeys.filter(key => key !== 'league.pts_win');
                            ptswin = document.createElement("P");
                            ptswin.textContent = "Points for a win: " + league.pts_win;
                            document.body.append(ptswin);
                        }

                        if ( league.standings ) {
                            dataKeys = dataKeys.filter(key => key !== 'league.standings');
                            drawStandings(league.standings);
                        }

                        if ( league.matches ) {
                            dataKeys = dataKeys.filter(key => key !== 'league.matches');
                            h3 = document.createElement("H3");
                            h3.textContent = "Matches";
                            document.body.append(h3);
                            drawMatchesGrid(league.matches);
                        }
                    });
                }

                if ( data.playoffs ) {
                    dataKeys = dataKeys.filter(key => key !== 'playoffs');
                    h2 = document.createElement("H2");
                    h2.textContent = "Playoffs";
                    document.body.append(h2);

                    Object.entries(data.playoffs).forEach(([poName, poData])=>{
                        h3 = document.createElement("H3");
                        dataKeys = dataKeys.filter(key => key !== ('playoffs.'+poName));
                        h3.textContent = playoffNames(poName);
                        h3.id = "playoff_" + poName;
                        document.body.append(h3);

                        poTeams = {};
                        if ( poData.loadTeams ) {
                            poTeams = poData.loadTeams;
                            dataKeys = dataKeys.filter(key => key !== ('playoffs.'+poName+'.loadTeams'));
                        }

                        if ( poData.matches ) {
                            dataKeys = dataKeys.filter(key => key !== ('playoffs.'+poName+'.matches'));
                            matchTable = document.createElement("TABLE");
                            matchTabelBody = document.createElement("TBODY");
                            matchTableHasDates = false;
                            poData.matches.forEach(match=>{
                                var [createdTr,rowHasDates] = drawMatch(match,"playoffs."+poName,true);
                                matchTabelBody.append(createdTr);
                                matchTableHasDates = matchTableHasDates || rowHasDates;
                            });
                            if ( ! matchTableHasDates ) {
                                matchTable.classList.add("matches-no-dates");
                            }
                            matchTable.append(matchTabelBody);
                            document.body.append(matchTable);
                        }

                        if ( poData.note ) {
                            dataKeys = dataKeys.filter(key => key !== ('playoffs.'+poName+'.note'));
                            note = document.createElement("P");
                            poNote = poData.note;
                            poTeams.forEach(key => {
                                poNote = poNote.replace(key,allTeams[key].name);
                            });
                            note.textContent = poNote;
                            document.body.append(note);

                        }
                    });
                }

                if ( dataKeys.length !== 0 ) {
                    console.warn(dataKeys);
                }
            }
            
            function drawSeries(league) {
                league.series.forEach(serie=>{
                    h2 = document.createElement("H2");
                    dataKeys = dataKeys.filter(key => key !== 'league.series.name');
                    dataKeys = dataKeys.filter(key => key !== 'league.name');
                    h2.textContent = league.name + " " + serie.name;
                    dataKeys = dataKeys.filter(key => key !== 'league.series.serie');
                    dataKeys = dataKeys.filter(key => key !== 'league.level');
                    h2.id = "league_" + league.level + "_" + serie.serie;
                    if ( serie.serie !== 1 ) {
                        h2.classList.add("series-title");
                    }
                    document.body.append(h2);

                    if ( serie.pts_win ) {
                        dataKeys = dataKeys.filter(key => key !== 'league.series.pts_win');
                        ptswin = document.createElement("P");
                        ptswin.textContent = "Points for a win: " + serie.pts_win;
                        document.body.append(ptswin);
                    }

                    if ( serie.standings ) {
                        dataKeys = dataKeys.filter(key => key !== 'league.series.standings');
                        drawStandings(serie.standings,"league.series");
                    }                    

                    if ( serie.matches ) {
                        dataKeys = dataKeys.filter(key => key !== 'league.series.matches');
                        h3 = document.createElement("H3");
                        h3.textContent = "Matches";
                        document.body.append(h3);
                        drawMatchesGrid(serie.matches,"league.series");
                    }
                });
            }

            function drawMatch(matchData,keyPrefix,highlightWinner=false) {
                match_tr = document.createElement("TR");
                hasDates = false;

                td_date = document.createElement("TD");
                if ( matchData.date ) {
                    hasDates = true;
                    td_date.textContent = matchData.date;
                    td_date.classList.add("match-date");
                    dataKeys = dataKeys.filter(key => key !== (keyPrefix+'.matches.date'));
                } else {
                    td_date.textContent = "";
                }
                match_tr.append(td_date);

                scoreParts = matchData.score.split("-");
                homeScore = parseInt(scoreParts[0]);
                awayScore = parseInt(scoreParts[1]);
                winner = "";
                if ( homeScore > awayScore ) {
                    winner = "home";
                } else if ( awayScore > homeScore ) {
                    winner = "away";
                }

                td_home = document.createElement("TD");
                td_home.textContent = allTeams[matchData.home].name;
                td_home.classList.add("team-name");
                td_home.classList.add("match-home");
                dataKeys = dataKeys.filter(key => key !== (keyPrefix+'.matches.home'));
                if ( highlightWinner && winner === "away" ) {
                    td_home.classList.add("match-loser");
                }
                match_tr.append(td_home);

                td_score = document.createElement("TD");
                td_score.textContent = matchData.score;
                if ( matchData.forfeit ) {
                    br = document.createElement("BR");
                    td_score.append(br);
                    td_score.append("(forfeit)");
                    dataKeys = dataKeys.filter(key => key !== (keyPrefix+'.matches.forfeit'));
                }
                td_score.classList.add("match-score");
                dataKeys = dataKeys.filter(key => key !== (keyPrefix+'.matches.score'));
                match_tr.append(td_score);

                td_away = document.createElement("TD");
                td_away.textContent = allTeams[matchData.away].name;
                td_away.classList.add("team-name");
                td_away.classList.add("match-away");
                dataKeys = dataKeys.filter(key => key !== (keyPrefix+'.matches.away'));
                if ( highlightWinner && winner === "home" ) {
                    td_away.classList.add("match-loser");
                }
                match_tr.append(td_away);

                td_outcome = document.createElement("TD");
                if ( matchData.outcome ) {
                    dataKeys = dataKeys.filter(key => key !== (keyPrefix+'.matches.outcome'));
                    td_outcome.innerHTML = matchData.outcome
                        .replace(matchData.home,allTeams[matchData.home].name)
                        .replace(matchData.away,allTeams[matchData.away].name)
                        .replace("|","<br/>")
                        ;
                } else if ( matchData.note ) {
                    dataKeys = dataKeys.filter(key => key !== (keyPrefix+'.matches.note'));
                    td_outcome.textContent = matchData.note
                        .replace(matchData.home,allTeams[matchData.home].name)
                        .replace(matchData.away,allTeams[matchData.away].name)
                        ;
                } else {
                    td_outcome.textContent = "";
                }
                td_outcome.classList.add("team-notes");
                match_tr.append(td_outcome);

                dataKeys = dataKeys.filter(key => key !== (keyPrefix+'.matches.playoff'));
                dataKeys = dataKeys.filter(key => key !== (keyPrefix+'.matches.season'));
                dataKeys = dataKeys.filter(key => key !== (keyPrefix+'.matches.level'));
                dataKeys = dataKeys.filter(key => key !== (keyPrefix+'.matches.league'));
                dataKeys = dataKeys.filter(key => key !== (keyPrefix+'.matches.series'));

                return [match_tr,hasDates];
            }

            function drawStandings(standingsData,prefix="league") {
                table = document.createElement("TABLE");
                hasNotes = false;
                
                thead = document.createElement("THEAD");
                thead_tr = document.createElement("TR");
                
                th_place = document.createElement("TH");
                th_place.textContent = "#";
                thead_tr.append(th_place);

                th_team = document.createElement("TH");
                th_team.textContent = "Team";
                thead_tr.append(th_team);

                stats = [
                    ["P","Played"],
                    ["W","Won"],
                    ["D","Draw"],
                    ["L","Lost"],
                    ["F","Goals For"],
                    ["A","Goals Against"],
                    ["Pts","Points"],
                    ["GD","Goal Difference"]
                ];
                stats.forEach(s=>{
                    th_stat = document.createElement("TH");
                    th_stat_abbr = document.createElement("ABBR");
                    th_stat_abbr.textContent = s[0];
                    th_stat_abbr.title = s[1];
                    th_stat.append(th_stat_abbr);
                    thead_tr.append(th_stat);
                });

                th_notes = document.createElement("TH");
                th_notes.textContent = "Notes";
                thead_tr.append(th_notes);

                thead.append(thead_tr);
                table.append(thead);

                tbody = document.createElement("TBODY");
                
                standingsData.forEach(row=>{
                    tbody_tr = document.createElement("TR");

                    tr_place = document.createElement("TD");
                    tr_place.textContent = row.place;
                    dataKeys = dataKeys.filter(key => key !== prefix + '.standings.place');
                    tbody_tr.append(tr_place);

                    tr_team = document.createElement("TD");
                    tr_team.textContent = allTeams[row.team].name;
                    tr_team.classList.add("team-name");
                    dataKeys = dataKeys.filter(key => key !== prefix + '.standings.team');
                    tbody_tr.append(tr_team);

                    if ( ! row.missing ) {
                        td_stat = document.createElement("TD");
                        td_stat.textContent = row.w + row.d + row.l;
                        tbody_tr.append(td_stat);
                        stats = ["w","d","l","f","a"];
                        stats.forEach(s=>{
                            td_stat = document.createElement("TD");
                            td_stat.textContent = row[s];
                            tbody_tr.append(td_stat);
                            dataKeys = dataKeys.filter(key => key !== prefix + '.standings.'+s);
                        });
                        td_stat = document.createElement("TD");
                        td_stat.textContent = (row.w*row.pts_win) + row.d;
                        tbody_tr.append(td_stat);
                        dataKeys = dataKeys.filter(key => key !== prefix + '.standings.pts_win');
                        td_stat = document.createElement("TD");
                        td_stat.textContent = row.f - row.a;
                        tbody_tr.append(td_stat);
                    } else {
                        dataKeys = dataKeys.filter(key => key !== prefix + '.standings.missing');
                        td_stats = document.createElement("TD");
                        td_stats.textContent = "Missing data";
                        td_stats.setAttribute("colspan",8);
                        tbody_tr.append(td_stats);
                    }

                    rowNotes = [];

                    if ( row.champion ) {
                        dataKeys = dataKeys.filter(key => key !== prefix + '.standings.champion');
                        tbody_tr.classList.add("is-champion");
                        rowNotes.push("Champion");
                    }
                    if ( row.promoted ) {
                        dataKeys = dataKeys.filter(key => key !== prefix + '.standings.promoted');
                        tbody_tr.classList.add("is-promoted");
                        rowNotes.push("Promoted");
                    }
                    if ( row.relegated ) {
                        dataKeys = dataKeys.filter(key => key !== prefix + '.standings.relegated');
                        tbody_tr.classList.add("is-relegated");
                        rowNotes.push("Relegated");
                    }
                    if ( row.removed ) {
                        dataKeys = dataKeys.filter(key => key !== prefix + '.standings.removed');
                        tbody_tr.classList.add("is-removed");
                        rowNotes.push("Removed");
                    }

                    if ( row.playoff ) {
                        dataKeys = dataKeys.filter(key => key !== prefix + '.standings.playoff');
                        playoffLink = document.createElement("A");
                        playoffLink.setAttribute("href","#playoff_"+row.playoff);
                        playoffLink.textContent = playoffNames(row.playoff);
                        rowNotes.push( playoffLink.outerHTML );
                    }

                    if ( row.note ) {
                        dataKeys = dataKeys.filter(key => key !== prefix + '.standings.note');
                        rowNotes.push(row.note);
                    }

                    tr_notes = document.createElement("TD");
                    if ( rowNotes.length !== 0 ) {
                        tr_notes.innerHTML = rowNotes.join("; ");
                        hasNotes = true;
                    }
                    tr_notes.classList.add("team-notes");
                    tbody_tr.append(tr_notes);

                    tbody.append(tbody_tr);
                });

                if ( ! hasNotes ) {
                    table.classList.add("standings-no-notes");
                }
                table.append(tbody);

                document.body.append(table);

                // ignore the properties used to copy standings to club pages
                dataKeys = dataKeys.filter(key => key !== prefix + '.standings.league');
                dataKeys = dataKeys.filter(key => key !== prefix + '.standings.level');
                dataKeys = dataKeys.filter(key => key !== prefix + '.standings.season');
                dataKeys = dataKeys.filter(key => key !== prefix + '.standings.series');
            }

            function drawMatchesGrid(matches,prefix="league") {
                matchGrid = {};
                matchGridNotes = [];

                recordHomeWin = [];
                recordHomeWinMargin = 0;
                recordAwayWin = [];
                recordAwayWinMargin = 0;
                recordHighestScoring = [];
                recordHighestScoringGoals = 0;

                matches.forEach(m=>{
                    if ( ! Object.keys(matchGrid).includes(m.home) ) {
                        matchGrid[m.home] = {};
                    }
                    matchGrid[m.home][m.away] = m.score;
                    if ( m.forfeit ) {
                        dataKeys = dataKeys.filter(key => key !== (prefix+'.matches.forfeit'));
                        matchGrid[m.home][m.away] = "<abbr title='Match forfeited'>"+m.score+"</abbr>";
                        matchGridNotes.push(
                            "* Match between " + allTeams[m.home].name + " and " + allTeams[m.away].name + " awarded as " + m.score + " forfeit"
                        );
                    }
                    dataKeys = dataKeys.filter(key => key !== (prefix+'.matches.home'));
                    dataKeys = dataKeys.filter(key => key !== (prefix+'.matches.away'));
                    dataKeys = dataKeys.filter(key => key !== (prefix+'.matches.score'));

                    /* statistics */
                    scoreParts = m.score.split("-");
                    homeScore = parseInt(scoreParts[0]);
                    awayScore = parseInt(scoreParts[1]);
                    totalGoals = homeScore + awayScore;
                    if ( totalGoals === recordHighestScoringGoals ) {
                        recordHighestScoring.push(m);
                    } else if ( totalGoals > recordHighestScoringGoals ) {
                        recordHighestScoring = [m];
                        recordHighestScoringGoals = totalGoals;
                    }
                    if ( homeScore > awayScore ) {
                        margin = homeScore - awayScore;
                        if ( margin === recordHomeWinMargin ) {
                            recordHomeWin.push(m);
                        } else if ( margin > recordHomeWinMargin ) {
                            recordHomeWinMargin = margin;
                            recordHomeWin = [m];
                        }
                    } else if ( awayScore > homeScore ) {
                        margin = awayScore - homeScore;
                        if ( margin === recordAwayWinMargin ) {
                            recordAwayWin.push(m);
                        } else if ( margin > recordAwayWinMargin ) {
                            recordAwayWinMargin = margin;
                            recordAwayWin = [m];
                        }
                    }

                    dataKeys = dataKeys.filter(key => key !== (prefix+'.matches.league'));
                    dataKeys = dataKeys.filter(key => key !== (prefix+'.matches.season'));
                    dataKeys = dataKeys.filter(key => key !== (prefix+'.matches.level'));
                    dataKeys = dataKeys.filter(key => key !== (prefix+'.matches.series'));
                });
                
                teams = Object.keys(matchGrid).sort();

                gridTable = document.createElement("TABLE");
                gridTableHead = document.createElement("THEAD");
                gridTableHeadRow = document.createElement("TR");
                gtTeam = document.createElement("TH");
                gtTeam.textContent = "";
                gridTableHeadRow.append(gtTeam);
                teams.forEach(t=>{
                    gtTeam = document.createElement("TH");
                    gtAbbr = document.createElement("ABBR");
                    gtAbbr.textContent = t;
                    gtAbbr.setAttribute("title",allTeams[t].name);
                    gtTeam.append(gtAbbr);
                    gridTableHeadRow.append(gtTeam);
                });
                gridTableHead.append(gridTableHeadRow);
                gridTable.append(gridTableHead);

                gtBody = document.createElement("TBODY");
                teams.forEach(h=>{
                    gtRow = document.createElement("TR");
                    gtHome = document.createElement("TD");
                    gtHome.textContent = allTeams[h].name;
                    gtHome.classList.add("team-name");
                    gtRow.append(gtHome);
                    teams.forEach(a=>{
                        gtScore = document.createElement("TD");
                        gtScore.innerHTML = matchGrid[h][a] ?? "-";
                        gtRow.append(gtScore);
                    });
                    gtBody.append(gtRow);
                });
                gridTable.append(gtBody);

                document.body.append(gridTable);

                matchGridNotes.forEach(note=>{
                    noteP = document.createElement("P");
                    noteP.textContent = note;
                    document.body.append(noteP);
                });
                
                statsUL = document.createElement("UL");
                statsLI = document.createElement("LI");
                statsLI.innerHTML = "Biggest home win&nbsp;&nbsp;&nbsp;&nbsp;: ";
                if ( recordHomeWin.length === 1 ) {
                    record = recordHomeWin[0];
                    statsLI.textContent = statsLI.textContent + allTeams[record.home].name + " " + record.score + " " + allTeams[record.away].name;
                } else {
                    statsSubUL = document.createElement("UL");
                    recordHomeWin.forEach(record=>{
                        statsSubLI = document.createElement("LI");
                        statsSubLI.textContent = allTeams[record.home].name + " " + record.score + " " + allTeams[record.away].name;
                        statsSubUL.append(statsSubLI);
                    });
                    statsLI.append(statsSubUL);
                }
                statsUL.append(statsLI);
                statsLI = document.createElement("LI");
                statsLI.innerHTML = "Biggest away win&nbsp;&nbsp;&nbsp;&nbsp;: ";
                if ( recordAwayWin.length === 1 ) {
                    record = recordAwayWin[0];
                    statsLI.textContent = statsLI.textContent + allTeams[record.home].name + " " + record.score + " " + allTeams[record.away].name;
                } else {
                    statsSubUL = document.createElement("UL");
                    recordAwayWin.forEach(record=>{
                        statsSubLI = document.createElement("LI");
                        statsSubLI.textContent = allTeams[record.home].name + " " + record.score + " " + allTeams[record.away].name;
                        statsSubUL.append(statsSubLI);
                    });
                    statsLI.append(statsSubUL);
                }
                statsUL.append(statsLI);
                statsLI = document.createElement("LI");
                statsLI.innerHTML = "Highest scoring game: ";
                if ( recordHighestScoring.length === 1 ) {
                    record = recordHighestScoring[0];
                    statsLI.textContent = statsLI.textContent + allTeams[record.home].name + " " + record.score + " " + allTeams[record.away].name;
                } else {
                    statsSubUL = document.createElement("UL");
                    recordHighestScoring.forEach(record=>{
                        statsSubLI = document.createElement("LI");
                        statsSubLI.textContent = allTeams[record.home].name + " " + record.score + " " + allTeams[record.away].name;
                        statsSubUL.append(statsSubLI);
                    });
                    statsLI.append(statsSubUL);
                }
                statsUL.append(statsLI);
                document.body.append(statsUL);
            }

            function getAllKeys(obj, prefix = '') {
                const keys = new Set();
                function traverse(current, path) {
                    if (current === null || typeof current !== 'object') {
                    return;
                    }
                    
                    if (Array.isArray(current)) {
                    // For arrays, traverse each element
                    current.forEach(item => traverse(item, path));
                    } else {
                    // For objects, add each key and traverse its value
                    Object.keys(current).forEach(key => {
                        const newPath = path ? `${path}.${key}` : key;
                        keys.add(newPath);
                        traverse(current[key], newPath);
                    });
                    }
                }                
                traverse(obj, prefix);
                return Array.from(keys).sort();
            }
        </script>
    </body>
</html>