<!DOCTYPE html>
<html>
    <head>
        <title>LuxFoot | Clubs</title>
        <link href="styles.css" rel="stylesheet" />
        <script src="scripts.js" type="text/javascript"></script>
    </head>
    <body>
        <h1>
            <a href="index.html">Luxembourgish Football</a>:
            <a href="clubs.html">Clubs</a>
        </h1>
        <script>
            params=[];
            window.location.search.replace("?","").split("&").forEach(param=>{parts=param.split("=");params[parts[0]]=parts[1];});
            team = params.team;
            allTeams = [];
            fetch("clubs/"+team.toLowerCase()+".json")
                .then(response => {
                    if ( ! response.ok ) {
                        errorP = document.createElement("P");
                        errorP.classList.add("error");
                        errorP.textContent = "Club not found";
                        document.body.append(errorP);
                        return {"invalid":true};
                    }
                    return response.json();
                })
                .then(data => {
                    if ( data.invalid ) {
                        return;
                    }

                    handleData(data);
                })
            
            function handleData(data) {
                dataKeys = getAllKeys(data);
                document.getElementsByTagName("title")[0].textContent += " | " + data.name;
                document.getElementsByTagName("h1")[0].innerHTML += " : " + data.name;
                dataKeys = dataKeys.filter(key => key !== 'name');
                allTeams[data.code] = {name:data.name};
                dataKeys = dataKeys.filter(key => key !== 'code');

                if ( data.league ) {
                    h2 = document.createElement("H2");
                    h2.textContent = "League history";
                    h2.id = "league";
                    document.body.append(h2);

                    drawStandings(data.league);
                    dataKeys = dataKeys.filter(key => key !== 'league');
                }

                if ( data.matches ) {
                    h2 = document.createElement("H2");
                    h2.textContent = "Matches";
                    h2.id = "matches";
                    document.body.append(h2);

                    drawMatches(data.matches);
                    dataKeys = dataKeys.filter(key => key !== 'league');
                }

                if ( dataKeys.length !== 0 ) {
                    console.warn(dataKeys);
                }
            }

            function drawMatches(data) {
                opponents = {};
                data.forEach(m=>{
                    opponent = "????";
                    goalsForTeam = 0;
                    goalsAgainstTeam = 0;
                    outcome = -1;

                    scoreParts = m.score.split("-");
                    homeScore = parseInt(scoreParts[0]);
                    awayScore = parseInt(scoreParts[1]);
                    if ( m.home === team ) {
                        opponent = m.away;
                        goalsForTeam = homeScore;
                        goalsAgainstTeam = awayScore;
                    } else {
                        opponent = m.home;
                        goalsForTeam = awayScore;
                        goalsAgainstTeam = homeScore;
                    }

                    if ( goalsForTeam > goalsAgainstTeam ) {
                        outcome = "0";
                    } else if ( goalsForTeam < goalsAgainstTeam ) {
                        outcome = "1";
                    } else if ( goalsForTeam === goalsAgainstTeam ) {
                        outcome = "2";
                    }

                    if ( opponent === "????" || outcome === -1 ) {
                        console.error(m);
                    } else {
                        if ( ! opponents[opponent] ) {
                            opponents[opponent] = [
                                0,0,0,0,0
                            ]
                        }
                        opponents[opponent][outcome]++;
                        opponents[opponent][4] += goalsForTeam;
                        opponents[opponent][5] += goalsAgainstTeam;
                    }
                });

                console.log(opponents);
            }

            function drawStandings(standingsData) {
                table = document.createElement("TABLE");
                hasNotes = false;
                
                thead = document.createElement("THEAD");
                thead_tr = document.createElement("TR");

                th_season = document.createElement("TH");
                th_season.textContent = "Season";
                thead_tr.append(th_season);

                th_level = document.createElement("TH");
                th_level.setAttribute("colspan",6);
                th_level.textContent = "Level";
                thead_tr.append(th_level);

                th_league = document.createElement("TH");
                th_league.textContent = "League";
                thead_tr.append(th_league);

                stats = [
                    ["P","Played"],
                    ["W","Won"],
                    ["D","Draw"],
                    ["L","Lost"],
                    ["F","Goals For"],
                    ["A","Goals Against"],
                    ["Pts","Points"],
                    ["GD","Goal Difference"]
                ];
                stats.forEach(s=>{
                    th_stat = document.createElement("TH");
                    th_stat_abbr = document.createElement("ABBR");
                    th_stat_abbr.textContent = s[0];
                    th_stat_abbr.title = s[1];
                    th_stat.append(th_stat_abbr);
                    thead_tr.append(th_stat);
                });

                th_notes = document.createElement("TH");
                th_notes.textContent = "Notes";
                thead_tr.append(th_notes);

                thead.append(thead_tr);
                table.append(thead);

                tbody = document.createElement("TBODY");
                
                standingsData.forEach(row=>{
                    tbody_tr = document.createElement("TR");

                    if ( row.gap ) {
                        dataKeys = dataKeys.filter(key => key !== 'league.gap');
                        tr_gap = document.createElement("TD");
                        tr_gap.textContent = "";
                        tr_gap.setAttribute("colspan",17);
                        tbody_tr.append(tr_gap);
                        tbody.append(tbody_tr);
                        return;
                    }

                    tr_season = document.createElement("TD");
                    tr_season.textContent = row.season;
                    dataKeys = dataKeys.filter(key => key !== 'league.season');
                    tbody_tr.append(tr_season);
                    
                    for ( i=0 ; i<6 ; i++ ) {
                        td_level = document.createElement("TD");
                        if ( row.level === (i+1) ) {
                            td_level.textContent = nth(row.place);
                            dataKeys = dataKeys.filter(key => key !== 'league.place');
                        } else {
                            td_level.textContent = "";
                        }
                        tbody_tr.append(td_level);
                    }
                    dataKeys = dataKeys.filter(key => key !== 'league.level');

                    tr_league = document.createElement("TD");
                    tr_league.textContent = row.league;
                    tr_league.classList.add("league-name");
                    dataKeys = dataKeys.filter(key => key !== 'league.league');
                    tbody_tr.append(tr_league);

                    if ( ! row.missing ) {
                        td_stat = document.createElement("TD");
                        td_stat.textContent = row.w + row.d + row.l;
                        tbody_tr.append(td_stat);
                        stats = ["w","d","l","f","a"];
                        stats.forEach(s=>{
                            td_stat = document.createElement("TD");
                            td_stat.textContent = row[s];
                            tbody_tr.append(td_stat);
                            dataKeys = dataKeys.filter(key => key !== 'league.'+s);
                        });
                        td_stat = document.createElement("TD");
                        td_stat.textContent = (row.w*row.pts_win) + row.d;
                        tbody_tr.append(td_stat);
                        dataKeys = dataKeys.filter(key => key !== 'league.pts_win');
                        td_stat = document.createElement("TD");
                        td_stat.textContent = row.f - row.a;
                        tbody_tr.append(td_stat);
                    } else {
                        dataKeys = dataKeys.filter(key => key !== 'league.missing');
                        td_stats = document.createElement("TD");
                        td_stats.textContent = "Missing data";
                        td_stats.setAttribute("colspan",8);
                        tbody_tr.append(td_stats);
                    }

                    rowNotes = [];

                    if ( row.champion ) {
                        dataKeys = dataKeys.filter(key => key !== 'league.champion');
                        tbody_tr.classList.add("is-champion");
                        rowNotes.push("Champion");
                    }
                    if ( row.promoted ) {
                        dataKeys = dataKeys.filter(key => key !== 'league.promoted');
                        tbody_tr.classList.add("is-promoted");
                        rowNotes.push("Promoted");
                    }
                    if ( row.relegated ) {
                        dataKeys = dataKeys.filter(key => key !== 'league.relegated');
                        tbody_tr.classList.add("is-relegated");
                        rowNotes.push("Relegated");
                    }
                    if ( row.removed ) {
                        dataKeys = dataKeys.filter(key => key !== 'league.removed');
                        tbody_tr.classList.add("is-removed");
                        rowNotes.push("Removed");
                    }

                    if ( row.playoff ) {
                        dataKeys = dataKeys.filter(key => key !== 'league.playoff');
                        rowNotes.push( playoffNames(row.playoff) );
                    }

                    if ( row.note ) {
                        dataKeys = dataKeys.filter(key => key !== 'league.note');
                        rowNotes.push(row.note);
                    }

                    tr_notes = document.createElement("TD");
                    if ( rowNotes.length !== 0 ) {
                        tr_notes.innerHTML = rowNotes.join("; ");
                        hasNotes = true;
                    }
                    tr_notes.classList.add("team-notes");
                    tbody_tr.append(tr_notes);

                    tbody.append(tbody_tr);
                });

                if ( ! hasNotes ) {
                    table.classList.add("standings-no-notes");
                }
                table.append(tbody);

                // unused properties
                dataKeys = dataKeys.filter(key => key !== 'league.team');
                dataKeys = dataKeys.filter(key => key !== 'league.series');

                document.body.append(table);
            }
            
            function nth(n) {
                s = ['th', 'st', 'nd', 'rd'];
                v = n % 100;
                return n + (s[(v - 20) % 10] || s[v] || s[0]);
            }

            function getAllKeys(obj, prefix = '') {
                const keys = new Set();
                function traverse(current, path) {
                    if (current === null || typeof current !== 'object') {
                    return;
                    }
                    
                    if (Array.isArray(current)) {
                    // For arrays, traverse each element
                    current.forEach(item => traverse(item, path));
                    } else {
                    // For objects, add each key and traverse its value
                    Object.keys(current).forEach(key => {
                        const newPath = path ? `${path}.${key}` : key;
                        keys.add(newPath);
                        traverse(current[key], newPath);
                    });
                    }
                }                
                traverse(obj, prefix);
                return Array.from(keys).sort();
            }

        </script>
    </body>
</html>